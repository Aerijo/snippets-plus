#!/usr/bin/env node

const cp = require("child_process");
const path = require("path");

let ATOM_APP_NAME;
let ATOM_SCRIPT_NAME;
let ATOM_SCRIPT_PATH;
let ATOM_PATH;
let APM_SCRIPT_PATH;

function isLinux() {
  return process.platform === "linux";
}

function isMac() {
  return process.platform === "darwin";
}

function isWindows() {
  return process.platform === "win32";
}

function setScriptNames(channel) {
  if (isMac()) {
    if (channel === "stable") {
      ATOM_APP_NAME = "Atom.app";
      ATOM_SCRIPT_NAME = "atom.sh";
    } else {
      ATOM_APP_NAME = `Atom ${channel}.app`;
      ATOM_SCRIPT_NAME = `atom-${channel}`;
    }
    ATOM_SCRIPT_PATH = `./atom/${ATOM_APP_NAME}/Contents/Resources/app/atom.sh`;
    ATOM_PATH = "./atom";
    APM_SCRIPT_PATH = `./atom/${ATOM_APP_NAME}/Contents/Resources/app/apm/node_modules/.bin/apm`
  } else if (isLinux()) {
    if (channel === "stable") {
      ATOM_SCRIPT_PATH = `${process.env.HOME}/atom/usr/bin/atom`;
      APM_SCRIPT_PATH = `${process.env.HOME}/atom/usr/bin/apm`;
    } else {
      ATOM_SCRIPT_PATH = `${process.env.HOME}/atom/usr/bin/atom-${channel}`;
      APM_SCRIPT_PATH = `${process.env.HOME}/atom/usr/bin/apm-${channel}`;
    }
  } else {
    console.error("Only mac and linux supported");
  }
}

function downloadAtom(platform, channel) {
  const downloadLink = `https://atom.io/download/${platform}?channel=${channel}`;
  const header = "Accept: application/octet-stream";

  let outFile;
  if (isLinux()) {
    outFile = "atom-amd64.deb";
  } else {
    outFile = "atom.zip";
  }

  console.log(`Downloading Atom from ${downloadLink} to file ${outFile}`);
  return {
    child: cp.spawnSync("curl", ["-s", "-L", "-H", header, downloadLink, "-o", outFile]),
    out: outFile,
    channel,
  };
}

function getAtomPlatform() {
  if (isLinux()) {
    return "deb";
  } else if (isMac()) {
    return "mac";
  } else if (isWindows()) {
    return "windows_zip";
  } else {
    throw new Error("Unknown platform");
  }
}

function installAtom(download) {
  console.log(download);



  if (isLinux()) {
    cp.execSync("dpkg-deb -x atom-amd64.deb \"${HOME}/atom\"");
  } else if (isMac()) {
    cp.execSync("mkdir atom && unzip -q atom.zip -d atom");
  }
}

function printVersions() {
  console.log("Atom version:");
  cp.execSync(`${ATOM_SCRIPT_PATH} --version`);

  console.log("apm version:");
  cp.execSync(`${APM_SCRIPT_PATH} --version`);
}

const channel = "stable";

setScriptNames(channel);

const context = installAtom(downloadAtom(getAtomPlatform(), channel));

console.log(context);

printVersions();

console.log("done");
